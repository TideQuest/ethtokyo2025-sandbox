"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.init = void 0;
const ethers_1 = require("ethers");
const utils_1 = require("../../utils");
const auth_1 = require("../../utils/auth");
const env_1 = require("../../utils/env");
const signatures_1 = require("../../utils/signatures");
const TOPRF_PUBLIC_KEY = (0, env_1.getEnvVariable)('TOPRF_PUBLIC_KEY');
const init = async (initRequest, { client }) => {
    var _a;
    if (client.isInitialised) {
        throw utils_1.AttestorError.badRequest('Client already initialised');
    }
    if (!signatures_1.SIGNATURES[initRequest.signatureType]) {
        throw utils_1.AttestorError.badRequest('Unsupported signature type');
    }
    if (initRequest.clientVersion <= 0) {
        throw utils_1.AttestorError.badRequest('Unsupported client version');
    }
    await (0, auth_1.assertValidAuthRequest)(initRequest.auth, initRequest.signatureType);
    if ((_a = initRequest.auth) === null || _a === void 0 ? void 0 : _a.data) {
        client.logger = client.logger.child({
            userId: initRequest.auth.data.id
        });
    }
    client.metadata = initRequest;
    client.isInitialised = true;
    return {
        toprfPublicKey: TOPRF_PUBLIC_KEY
            ? ethers_1.ethers.utils.arrayify(TOPRF_PUBLIC_KEY)
            : new Uint8Array()
    };
};
exports.init = init;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvaGFuZGxlcnMvaW5pdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBK0I7QUFFL0IscUNBQXlDO0FBQ3pDLHlDQUF1RDtBQUN2RCx1Q0FBOEM7QUFDOUMscURBQWlEO0FBRWpELE1BQU0sZ0JBQWdCLEdBQUcsSUFBQSxvQkFBYyxFQUFDLGtCQUFrQixDQUFDLENBQUE7QUFFcEQsTUFBTSxJQUFJLEdBQXVCLEtBQUssRUFDNUMsV0FBVyxFQUNYLEVBQUUsTUFBTSxFQUFFLEVBQ1QsRUFBRTs7SUFDSCxJQUFHLE1BQU0sQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN6QixNQUFNLHFCQUFhLENBQUMsVUFBVSxDQUFDLDRCQUE0QixDQUFDLENBQUE7SUFDN0QsQ0FBQztJQUVELElBQUcsQ0FBQyx1QkFBVSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDO1FBQzNDLE1BQU0scUJBQWEsQ0FBQyxVQUFVLENBQUMsNEJBQTRCLENBQUMsQ0FBQTtJQUM3RCxDQUFDO0lBRUQsSUFBRyxXQUFXLENBQUMsYUFBYSxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQ25DLE1BQU0scUJBQWEsQ0FBQyxVQUFVLENBQUMsNEJBQTRCLENBQUMsQ0FBQTtJQUM3RCxDQUFDO0lBRUQsTUFBTSxJQUFBLDZCQUFzQixFQUMzQixXQUFXLENBQUMsSUFBSSxFQUNoQixXQUFXLENBQUMsYUFBYSxDQUN6QixDQUFBO0lBRUQsSUFBRyxNQUFBLFdBQVcsQ0FBQyxJQUFJLDBDQUFFLElBQUksRUFBRSxDQUFDO1FBQzNCLE1BQU0sQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7WUFDbkMsTUFBTSxFQUFFLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7U0FDaEMsQ0FBQyxDQUFBO0lBQ0gsQ0FBQztJQUVELE1BQU0sQ0FBQyxRQUFRLEdBQUcsV0FBVyxDQUFBO0lBQzdCLE1BQU0sQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFBO0lBRTNCLE9BQU87UUFDTixjQUFjLEVBQUUsZ0JBQWdCO1lBQy9CLENBQUMsQ0FBQyxlQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQztZQUN6QyxDQUFDLENBQUMsSUFBSSxVQUFVLEVBQUU7S0FDbkIsQ0FBQTtBQUNGLENBQUMsQ0FBQTtBQW5DWSxRQUFBLElBQUksUUFtQ2hCIn0=